var filelink;
var count = 0;
var timer;
var done = 0;
var result = [];
var predictList = [];
var image_md5 = '';

function uploadFile() {
    var inputFile = document.getElementById('inputFile');
    inputFile.click();
}
function showFileName(e) {
    filelink = []
    const file = e.files[0];
    if (!file) {
        return;
    }

    const reader = new FileReader();
    reader.onload = function (e) {
        filelink = e.target.result;
    };  
    // console.log(file.size)
    if(file.size <= 100 * 1024 * 1024) {
        reader.readAsBinaryString(file)
        const fileName = document.getElementById('fileName');

        fileName.innerText = file.name;
        if(count > 0){
            done = 0;
            count = 0;
            clearInterval(timer);
        }
        reset();
    }
    else alert('File size is over 100MB')
}

function startAnalyze(){
    if(count > 0){
        return;
    }
    reset();

    // result = predict(filelink)
    (async () => {
        if(filelink) {
            result = await predict(filelink)
            predictList = await result['predictList']
            image_md5 = await result['md5']
            timer = setInterval(showProgress , 30);
            filelink = null
        }
    })();

}

function showProgress(){
    var progressBar = document.getElementById('progressBar');
    progressBar.style.width =  count +"%";
    count++;

    if(count > 50 && !done) {
        count = 50;
    }
    if(count > 100){
        clearInterval(timer);
        showResult(result);
    }
}

function showResult(result){
    if(typeof(result) == 'string'){
        alert(result)
        return
    }
    var DownloadBtn = document.getElementById('DownloadBtn');
    var picture = document.getElementById('detailPicture');
    var detailMalware_list = document.querySelectorAll('#detailMalware');
    var tick_class = document.querySelectorAll('.tick_op')
    var middle_class = document.querySelectorAll('.middle_op')
    var frames = document.querySelectorAll('.frame');
    var ticks = document.querySelectorAll('.tick');
    var showDetailBtn = document.getElementById('showDetailBtn');


    showDetailBtn.hidden = false;

    picture.src = 'images/'+image_md5
    DownloadBtn.href = 'images/'+image_md5
    DownloadBtn.download = 'image_'+image_md5+'.png'

    if(Number(predictList[5]) >= 0.55){
        var middle_name = document.getElementById('middle_name')
        var middle_malware = document.getElementById('middle_malware')
        middle_name.innerText = 'Not a Virus'
        middle_malware.src = 'static/shield' 

        detailMalware_list[5].style.display = 'inline';
        tick_class[2].style.opacity = 1;
        middle_class[2].style.opacity = 1;
        frames[2].hidden = true;
        ticks[2].hidden = false;
    }
    else{
        for(let i = 0; i < detailMalware_list.length - 1; i++){
            if(Number(predictList[i]) >= 0.55){
                detailMalware_list[i].style.display = 'inline';
                tick_class[i].style.opacity = 1;
                middle_class[i].style.opacity = 1;
                frames[i].hidden = true;
                ticks[i].hidden = false;
            }else {
                detailMalware_list[i].style.display = 'none';
            }
        }
    }


    adware_donut = Number(predictList[0])*100;
    backdoor_donut = Number(predictList[1])*100;
    ransom_donut = Number(predictList[2])*100;
    trojan_donut = Number(predictList[3])*100;
    worm_donut = Number(predictList[4])*100;
    normal_donut = Number(predictList[5])*100;
 
    adware_bar = Number(predictList[0])*100;
    backdoor_bar = Number(predictList[1])*100;
    ransom_bar = Number(predictList[2])*100;
    trojan_bar = Number(predictList[3])*100;
    worm_bar = Number(predictList[4])*100;
    normal_bar = Number(predictList[5])*100;


    window.onload();
}

function showDetail(){
    var detailFileName = document.getElementById('detailFileName');
    detailFileName.innerText = image_md5;
    
    var detail = document.getElementById('detail');
    detail.hidden = false;
}

function reset(){
    var middle_name = document.getElementById('middle_name')
    var middle_malware = document.getElementById('middle_malware')
    var progressBar = document.getElementById('progressBar');
    var detailMalware_list = document.querySelectorAll('#detailMalware');
    progressBar.style.width =  0 +"%";
    var progressBar = document.getElementById('showDetailBtn');
    showDetailBtn.hidden = true;
    var frames = document.querySelectorAll('.frame');
    var ticks = document.querySelectorAll('.tick');
    var tick_class = document.querySelectorAll('.tick_op')
    var middle_class = document.querySelectorAll('.middle_op')
    for(let i = 0; i < frames.length; i++){
        detailMalware_list[i].style.display = 'none';
        tick_class[i].style.opacity = 0.3;
        middle_class[i].style.opacity = 0.3;
        ticks[i].hidden = true;
        frames[i].hidden = false;
    }
    detailMalware_list[5].style.display = 'none';

    middle_name.innerText = 'Ransom'
    middle_malware.src = '/static/img/monster3.png' 
}

function closeDetail(){
    var detail = document.getElementById('detail');
    detail.hidden = true;
}

// var adware_donut = 53;
// var backdoor_donut = 30;
// var worm_donut = 7;
// var trojan_donut = 5;
// var ransom_donut = 5;
// var adware_bar = 25;
// var backdoor_bar = 50;
// var worm_bar = 74;
// var trojan_bar = 20;
// var ransom_bar = 20;

window.onload = function () {
    // var chart1 = new CanvasJS.Chart("chartContainer1", {
    //     theme: "dark2",
    //     title:{
    //         text: "Cumulative Malware Samples Classifications",
    //         fontFamily: "Impact",
    //         fontWeight: "normal",
    //     },

    //     legend:{
    //         verticalAlign: "bottom",
    //         horizontalAlign: "center",
    //     },

    //     data: [{
    //     //startAngle: 45,
    //         indexLabelFontSize: 20,
    //         indexLabelFontFamily: "Garamond",
    //         indexLabelFontColor: "darkgrey",
    //         indexLabelLineColor: "darkgrey",
    //         indexLabelPlacement: "outside",
    //         type: "doughnut",
    //         showInLegend: true,
    //         dataPoints: [
    //             { y: adware_donut, legendText: "Adware " + adware_donut + "%", indexLabel: "Adware " + adware_donut + "%" },
    //             { y: backdoor_donut, legendText: "Backdoor " + backdoor_donut + "%", indexLabel: "Backdoor " + backdoor_donut + "%" },
    //             { y: worm_donut, legendText:"Ransom " + ransom_donut + "%", indexLabel: "Ransom " + ransom_donut + "%" },
    //             { y: trojan_donut, legendText:"Trojan " + trojan_donut + "%", indexLabel: "Trojan " + trojan_donut + "%" },
    //             { y: ransom_donut, legendText:"Worm " + worm_donut + "%", indexLabel: "Worm " + worm_donut + "%" },
    //         ]
    //     }]
    // });
    // chart1.render();

    var chart2 = new CanvasJS.Chart("chartContainer2", {
        animationEnabled: true,
        theme: "dark1", // "light1", "light2", "dark1", "dark2"
        title:{
            text: "Posibility Of Classification"
        },
        axisY: {
            title: "posibility(%)",
            minimum: 0,
            maximum: 100,
        },
        data: [{        
            type: "column",  
            showInLegend: true, 
            legendMarkerColor: "grey",
            legendText: "classification",
            dataPoints: [      
                { y: adware_bar, label: "Adware" },
                { y: backdoor_bar,  label: "Backdoor" },
                { y: ransom_bar,  label: "Ransom" },
                { y: trojan_bar,  label: "Trojan" },
                { y: worm_bar,  label: "Worm" },
                { y: normal_bar, label: "Normal"}
            ]
        }]
    });
    chart2.render();
  }