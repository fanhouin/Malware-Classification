var filelink;
var count = 0;
var timer;
var done = 0;
var result = [];
var predictList = [];
var md5 = '';

function uploadFile() {
    var inputFile = document.getElementById('inputFile');
    inputFile.click();
}
function showFileName(e) {
    filelink = []
    const file = e.files[0];
    if (!file) {
        return;
    }

    const reader = new FileReader();
    reader.onload = function (e) {
        filelink = e.target.result;
    };  
    console.log(file.size)
    if(file.size <= 100 * 1024 * 1024) {
        reader.readAsBinaryString(file)
        const fileName = document.getElementById('fileName');

        fileName.innerText = file.name;
        if(count > 0){
            done = 0;
            count = 0;
            clearInterval(timer);
        }
        reset();
    }
    else alert('File size is over 100MB')
}

function startAnalyze(){
    if(count > 0){
        return;
    }
    reset();
    timer = setInterval(showProgress , 30);

    // result = predict(filelink)
    (async () => {
        if(filelink) {
            result = await predict(filelink)
            predictList = await result['predictList']
            image_md5 = await result['md5']
            filelink = null
        }
    })();

}

function showProgress(){
    var progressBar = document.getElementById('progressBar');
    progressBar.style.width =  count +"%";
    count++;

    if(count > 50 && !done) {
        count = 50;
    }
    if(count > 100){
        clearInterval(timer);
        showResult(result);
        // console.log(result)
    }
}

function showResult(result){
    if(typeof(result) == 'string'){
        alert(result)
        return
    }
    var DownloadBtn = document.getElementById('DownloadBtn');
    var picture = document.getElementById('detailPicture');
    var detailMalware_list = document.querySelectorAll('#detailMalware');
    var frames = document.querySelectorAll('.frame');
    var ticks = document.querySelectorAll('.tick');
    var showDetailBtn = document.getElementById('showDetailBtn');
    showDetailBtn.hidden = false;

    picture.src = 'images/'+image_md5
    DownloadBtn.href = 'images/'+image_md5
    DownloadBtn.download = 'image_'+image_md5+'.png'

    for(let i = 0; i < frames.length; i++){
        if(Number(predictList[i]) >= 0.6){
            frames[i].hidden = true;
            ticks[i].hidden = false;
            detailMalware_list[i].style.display = 'inline';
        }else {
            detailMalware_list[i].style.display = 'none';
        }
    }

    adware_donut = Number(predictList[0])*100;
    backdoor_donut = Number(predictList[1])*100;
    ransom_donut = Number(predictList[2])*100;
    trojan_donut = Number(predictList[3])*100;
    worm_donut = Number(predictList[4])*100;
 
    adware_bar = Number(predictList[0])*100;
    backdoor_bar = Number(predictList[1])*100;
    ransom_bar = Number(predictList[2])*100;
    trojan_bar = Number(predictList[3])*100;
    worm_bar = Number(predictList[4])*100;

    window.onload();
}

function showDetail(){
    var detailFileName = document.getElementById('detailFileName');
    var fileName = document.getElementById('fileName');
    detailFileName.innerText = fileName.innerText;
    
    var detail = document.getElementById('detail');
    detail.hidden = false;
}

function reset(){
    var progressBar = document.getElementById('progressBar');
    progressBar.style.width =  0 +"%";
    var progressBar = document.getElementById('showDetailBtn');
    showDetailBtn.hidden = true;
    var frames = document.querySelectorAll('.frame');
    var ticks = document.querySelectorAll('.tick');
    for(let i = 0; i < frames.length; i++){
        ticks[i].hidden = true;
        frames[i].hidden = false;
    }
}

function closeDetail(){
    var detail = document.getElementById('detail');
    detail.hidden = true;
}

var adware_donut = 53;
var backdoor_donut = 30;
var worm_donut = 7;
var trojan_donut = 5;
var ransom_donut = 5;
var adware_bar = 25;
var backdoor_bar = 50;
var worm_bar = 74;
var trojan_bar = 20;
var ransom_bar = 20;

window.onload = function () {
    var chart1 = new CanvasJS.Chart("chartContainer1", {
        theme: "dark2",
        title:{
            text: "Cumulative Malware Samples Classifications",
            fontFamily: "Impact",
            fontWeight: "normal",
        },

        legend:{
            verticalAlign: "bottom",
            horizontalAlign: "center",
        },

        data: [{
        //startAngle: 45,
            indexLabelFontSize: 20,
            indexLabelFontFamily: "Garamond",
            indexLabelFontColor: "darkgrey",
            indexLabelLineColor: "darkgrey",
            indexLabelPlacement: "outside",
            type: "doughnut",
            showInLegend: true,
            dataPoints: [
                { y: adware_donut, legendText: "Adware " + adware_donut + "%", indexLabel: "Adware " + adware_donut + "%" },
                { y: backdoor_donut, legendText: "Backdoor " + backdoor_donut + "%", indexLabel: "Backdoor " + backdoor_donut + "%" },
                { y: worm_donut, legendText:"Ransom " + ransom_donut + "%", indexLabel: "Ransom " + ransom_donut + "%" },
                { y: trojan_donut, legendText:"Trojan " + trojan_donut + "%", indexLabel: "Trojan " + trojan_donut + "%" },
                { y: ransom_donut, legendText:"Worm " + worm_donut + "%", indexLabel: "Worm " + worm_donut + "%" },
            ]
        }]
    });
    chart1.render();

    var chart2 = new CanvasJS.Chart("chartContainer2", {
        animationEnabled: true,
        theme: "dark1", // "light1", "light2", "dark1", "dark2"
        title:{
            text: "Posibility Of Classification"
        },
        axisY: {
            title: "posibility(%)"
        },
        data: [{        
            type: "column",  
            showInLegend: true, 
            legendMarkerColor: "grey",
            legendText: "classification",
            dataPoints: [      
                { y: adware_bar, label: "Adware" },
                { y: backdoor_bar,  label: "Backdoor" },
                { y: ransom_bar,  label: "Ransom" },
                { y: trojan_bar,  label: "Trojan" },
                { y: worm_bar,  label: "Worm" }
            ]
        }]
    });
    chart2.render();
  }