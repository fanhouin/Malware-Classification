import flask
import model
import change_image
import numpy as np
import io
import requests
from flask import jsonify, request, render_template, make_response, send_file

app = flask.Flask(__name__)
app.config["DEBUG"] = True
app.config["JSON_AS_ASCII"] = False
app.config['MAX_CONTENT_LENGTH'] = 100 * 1024 * 1024 #Max size: 100MB

@app.route('/', methods = ['GET'])
def home():
    return render_template('index.html')

@app.route('/static/<string:pid>')
def get_static(pid):
    try:
        return send_file('./static/img/'+pid+'.png', mimetype='image/png')
    except:
        return 'Sorry, image not found'

@app.route('/images/<string:pid>', methods = ['GET'])
def get_image(pid):
    try:
        return send_file('./image_cache/'+pid+'.png', mimetype='image/png')
    except:
        return 'Sorry, image not found'
    # return send_file('./app/image_cache/'+pid+'.png', mimetype='image/png')

@app.route('/predict', methods = ['POST'])
def prediction():
    file = request.values['file']
    # try:
    if(file):
        predictList, md5 = change_image.change(file)
        result = {
            'predictList': predictList,
            'md5': md5
        }

        return jsonify(result)
    #     else:
    #         return "Oops, something went wrong! Maybe the file is too large"
    # except:
    #     return "Oops, something went wrong! Maybe the file is too large"
    # result, image = change_image.change(file)

    # data = {
    #     'result': result,
    #     'image': image
    # }
    # image_binary = np.array(image).tobytes()
    # response = make_response(image_binary)
    # response.headers.set('Content-Type', 'image/png')
    # response.headers.set('Content-Disposition', 'attachment', filename='malware_image.png')
    # # response = Response(image, minetype='image/jpeg')
    # return response

if __name__ == '__main__':
    app.run(debug=True, host='0.0.0.0')