from bs4 import BeautifulSoup #分析html的標籤用, 可以把例如<h1> <p>那些標籤拆開來, 放在array裏
from urllib.request import urlretrieve
import threading
import re #正規表示式
import requests #get or post網頁用
import time
import sys

#url post的時候, 需要用的form data query
#可以看 https://hackmd.io/aQF09eAPSDCFej0qvTUk6A?both
payload = {
    'page':1, #你想去的頁數
    'total_page':29235 #總頁數, 它php的script會判斷最大頁數,會在最大頁數停下來, 這個隨便設都可以
}

#url post的時候, 需要用的form data query, 這是download malware用, 這份code還沒用到它
download = {
    'md5':'01108dbee9f9e77eb14e75dc4ef1f410',
    'action':'download'
}


#使用者帳密的cookie, 跟Trojan PE file type分類的cookie
cookies ={
    #e.g 'cookiesession1':'123123123123123123',
    #    'PHPSESSID':'12312312312312312312'
}

header = {
    'Accept-Encoding': 'gzip',
    'Content-Type': 'application/x-www-form-urlencoded'
}


def papa(page_start,page_end):
    all_count = 0 
    for page in range(page_start , page_end):
        print('((((((((((((((',page,'))))))))))))))')
        payload['page'] = page
        res = requests.post('https://owl.nchc.org.tw/search.php', data = payload, cookies = cookies)#post取網頁的html
        soup = BeautifulSoup(res.text,'html.parser') #res.text是整個html的string, 而BeautifulSoup可以在string中分析到html的標籤
        td = soup.select('table.table.table-hover tbody tr td')#td就是每個軟體row的各個資訊
        #time.sleep(7)
        for i in range(600): #每個軟體有6個資訊, 100個就有600個資訊
            if(i % 6 == 0):
                rate_td = td[i+3]
                if (rate_td.text != ' Analyzing...'): #因為有些分數還在Analyzing, 如果還在Analyzing就跳過
                    fraction = int(re.findall(r'(.+)/.+', rate_td.text)[0]) #正規表示式選擇 44/55 中的 44
                    denominator  = int(re.findall(r'.+/(.+)', rate_td.text)[0])#正規表示式選擇 44/55 中的 55
                    rate = round((fraction/denominator),3)

                    if(rate > 0.8): #計算分數>0.8為可信的惡意軟體
                        type_td = td[i+4]
                        type_td_span = type_td.select('span')
                        multiple = False 
                        for thespan in type_td_span: #判斷只有一個type
                            #[TODO]
                            if(thespan.text != 'Backdoor'): #***********************這個判斷你想download哪個type的malware********************
                                multiple = True
                                break
	                
                        if not multiple:
                            #count += 1
                            #all_count += 1
                            #print('---------------------',count,'---------------------')
                            #print('md5:',td[i].text)
                            #print('rate:',rate_td.text,'--->',rate)
                            
                            count = 0
                            while(1):
                                download['md5'] = td[i].text.strip()
                                down = requests.post('https://owl.nchc.org.tw/search.php', data = download, cookies = cookies,headers = header)
                                # print(down.headers.get('content-type'))
                                if(down.headers.get('content-type') == 'application/zip'):
                                    open(download['md5'], 'wb').write(down.content)
                                    print('Download Successful: ',download['md5'])
                                    time.sleep(7)
                                    break
                                else:
                                    count += 1
                                    print('Download Try Again',count,':',download['md5'])
                                    time.sleep(7)


if __name__=='__main__':
	papa(int(sys.argv[1]),int(sys.argv[2]))
